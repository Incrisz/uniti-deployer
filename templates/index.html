<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Cron Scheduler</title>
    <style>
      :root {
        color-scheme: light;
      }

      body {
        font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
        background: #f8fafc;
        color: #0f172a;
        margin: 0;
        padding: 0;
      }

      .top-bar {
        background: #0f172a;
        color: #e2e8f0;
        padding: 0.9rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .brand {
        font-weight: 600;
        letter-spacing: 0.04em;
      }

      .user-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-label {
        font-size: 0.9rem;
        color: #cbd5f5;
      }

      .user-controls form {
        margin: 0;
      }

      .logout-btn {
        background: rgba(226, 232, 240, 0.1);
        color: #e2e8f0;
        border: 1px solid rgba(226, 232, 240, 0.3);
      }

      .logout-btn:hover:not(:disabled) {
        background: rgba(226, 232, 240, 0.2);
      }

      main {
        max-width: 880px;
        margin: 0 auto;
        padding: 2.5rem 1.5rem 3rem;
        display: flex;
        flex-direction: column;
        gap: 1.75rem;
      }

      h1 {
        font-size: 1.9rem;
        margin: 0 0 0.5rem;
      }

      p.lead {
        margin: 0;
        color: #475569;
      }

      section {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
      }

      section h2 {
        margin: 0 0 1.1rem;
        font-size: 1.25rem;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        font-size: 0.9rem;
        color: #334155;
      }

      input {
        padding: 0.6rem 0.75rem;
        border-radius: 8px;
        border: 1px solid #cbd5f5;
        font-size: 0.95rem;
        background: #ffffff;
      }

      input:focus {
        border-color: #2563eb;
        outline: none;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.18);
      }

      button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        background: #2563eb;
        color: #ffffff;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s ease-in-out;
      }

      button:hover:not(:disabled) {
        background: #1d4ed8;
      }

      button:disabled {
        background: #94a3b8;
        cursor: not-allowed;
      }

      button.secondary {
        background: #f1f5f9;
        color: #1e293b;
      }

      button.secondary:hover:not(:disabled) {
        background: #e2e8f0;
      }

      .button-row {
        margin-top: 1.2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
      }

      .helper {
        margin-top: 0.45rem;
        font-size: 0.85rem;
        color: #64748b;
      }

      #status-board {
        display: grid;
        gap: 0.55rem;
        font-size: 0.95rem;
      }
      .status-value-strong {
        font-weight: 600;
      }

      .status-line {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .badge {
        display: inline-block;
        padding: 0.18rem 0.65rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        background: #e2e8f0;
        color: #1e293b;
      }

      .badge[data-state="active"] {
        background: #bbf7d0;
        color: #166534;
      }

      .badge[data-state="inactive"] {
        background: #fee2e2;
        color: #b91c1c;
      }

      .badge[data-state="idle"] {
        background: #dbeafe;
        color: #1d4ed8;
      }

      .badge[data-state="success"] {
        background: #bbf7d0;
        color: #166534;
      }

      .badge[data-state="failed"] {
        background: #fecaca;
        color: #b91c1c;
      }

      pre {
        background: #0f172a;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 10px;
        overflow-x: auto;
        white-space: pre-wrap;
        line-height: 1.5;
        border: 1px solid #1e293b;
        min-height: 120px;
      }

      pre[data-status="running"] {
        border-left: 4px solid #f59e0b;
      }

      pre[data-status="success"] {
        border-left: 4px solid #16a34a;
      }

      pre[data-status="failed"] {
        border-left: 4px solid #dc2626;
      }

      #flash {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-top: 0.75rem;
        font-size: 0.9rem;
      }

      #flash[data-state="info"] {
        background: #dbeafe;
        color: #1d4ed8;
      }

      #flash[data-state="success"] {
        background: #dcfce7;
        color: #166534;
      }

      #flash[data-state="error"] {
        background: #fee2e2;
        color: #b91c1c;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 640px) {
        main {
          padding: 1.75rem 1rem 2.5rem;
        }

        .button-row {
          flex-direction: column;
        }

        button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header class="top-bar">
      <div class="brand">Web Cron Scheduler</div>
      <div class="user-controls">
        <span class="user-label">Signed in as {{ session.get('username', 'admin') }}</span>
        <form action="/logout" method="post">
          <button type="submit" class="logout-btn">Log Out</button>
        </form>
      </div>
    </header>
    <main>
      <header>
        <h1>Scheduler Dashboard</h1>
        <p class="lead">
          Configure a cron-like schedule, start or stop it on demand, and trigger the job manually from the browser.
        </p>
      </header>

      <section>
        <h2>Cron Schedule</h2>
        <form id="schedule-form" autocomplete="off">
          <div class="grid">
            <label>
              <span>Minute</span>
              <input type="text" name="minute" placeholder="0" />
            </label>
            <label>
              <span>Hour</span>
              <input type="text" name="hour" placeholder="*" />
            </label>
            <label>
              <span>Day of Month</span>
              <input type="text" name="day_of_month" placeholder="*" />
            </label>
            <label>
              <span>Month</span>
              <input type="text" name="month" placeholder="*" />
            </label>
            <label>
              <span>Day of Week</span>
              <input type="text" name="day_of_week" placeholder="*" />
            </label>
          </div>
          <p class="helper">
            Use standard cron syntax. Leaving a field empty defaults to <code>*</code>. Saving the schedule will enable the
            background job.
          </p>
          <div class="button-row">
            <button type="submit" id="save-schedule">Save &amp; Start Cron</button>
            <button type="button" class="secondary hidden" id="stop-cron">Stop Cron</button>
          </div>
        </form>
        <div id="flash" class="hidden" data-state="info"></div>
      </section>

      <section>
        <h2>Daily Time Scheduler</h2>
        <form id="daily-form" autocomplete="off">
          <label>
            <span>Daily run time</span>
            <input type="time" name="daily-time" id="daily-time" />
          </label>
          <p class="helper">
            Select a daily server time using 24-hour format (e.g., <code>21:00</code>). Saving this schedule replaces any
            cron expression. The job runs once per day at that server time.
          </p>
          <div class="button-row">
            <button type="submit" id="save-daily">Save &amp; Start Daily</button>
            <button type="button" class="secondary hidden" id="stop-daily">Stop Daily</button>
          </div>
        </form>
      </section>

      <section>
        <h2>Manual Run</h2>
        <p class="helper">Trigger the cron job right now without waiting for the next schedule.</p>
        <button id="run-now">Run Job Now</button>
      </section>

      <section>
        <h2>Status</h2>
        <div id="status-board">
          <div class="status-line">
            <strong>Server time:</strong>
            <span id="server-time" class="status-value-strong">—</span>
          </div>
          <div class="status-line">
            <strong>Server timezone:</strong>
            <span id="server-timezone-status">—</span>
          </div>
          <div class="status-line">
            <strong>Cron schedule:</strong>
            <span class="badge" id="cron-state" data-state="inactive">Stopped</span>
            <span id="cron-next-run" class="helper"></span>
          </div>
          <div class="status-line">
            <strong>Daily schedule:</strong>
            <span class="badge" id="daily-state" data-state="inactive">Stopped</span>
            <span id="daily-next-run" class="helper"></span>
          </div>
          <div class="status-line">
            <strong>Scheduler:</strong>
            <span class="badge" id="scheduler-state" data-state="inactive">Stopped</span>
          </div>
          <div class="status-line">
            <strong>Job:</strong>
            <span class="badge" id="running-state" data-state="idle">Idle</span>
            <span id="current-trigger" class="helper"></span>
          </div>
          <div class="status-line">
            <strong>Next run:</strong>
            <span id="next-run">—</span>
          </div>
          <div class="status-line">
            <strong>Last run:</strong>
            <span id="last-run">Never</span>
          </div>
          <div class="status-line">
            <strong>Result:</strong>
            <span class="badge" id="last-result-state" data-state="idle">Pending</span>
            <span id="last-result" class="helper"></span>
          </div>
          <div class="status-line">
            <strong>Runs completed:</strong>
            <span id="run-count">0</span>
          </div>
        </div>
      </section>

      <section>
        <h2>Latest Message</h2>
        <pre id="output" data-status="idle">No runs yet.</pre>
      </section>
    </main>

    <script>
      const scheduleForm = document.getElementById("schedule-form");
      const flash = document.getElementById("flash");
      const runBtn = document.getElementById("run-now");
      const saveScheduleBtn = document.getElementById("save-schedule");
      const stopCronBtn = document.getElementById("stop-cron");
      const dailyForm = document.getElementById("daily-form");
      const dailyInput = document.getElementById("daily-time");
      const saveDailyBtn = document.getElementById("save-daily");
      const stopDailyBtn = document.getElementById("stop-daily");
      const schedulerBadge = document.getElementById("scheduler-state");
      const cronBadge = document.getElementById("cron-state");
      const cronNextRunLabel = document.getElementById("cron-next-run");
      const dailyBadge = document.getElementById("daily-state");
      const dailyNextRunLabel = document.getElementById("daily-next-run");
      const runningBadge = document.getElementById("running-state");
      const triggerLabel = document.getElementById("current-trigger");
      const nextRunLabel = document.getElementById("next-run");
      const lastRunLabel = document.getElementById("last-run");
      const lastResultBadge = document.getElementById("last-result-state");
      const lastResultText = document.getElementById("last-result");
      const runCountLabel = document.getElementById("run-count");
      const serverTimeLabel = document.getElementById("server-time");
      const serverTimezoneLabel = document.getElementById("server-timezone-label");
      const serverTimezoneStatus = document.getElementById("server-timezone-status");
      const browserTimezoneLabel = document.getElementById("browser-timezone");
      const dailyLocalEquivalentLabel = document.getElementById("daily-local-equivalent");
      const output = document.getElementById("output");

      let flashTimeoutId = null;
      let scheduleInitialized = false;
      let dailyInitialized = false;
      let serverOffsetMinutes = 0;

      const cronFields = ["minute", "hour", "day_of_month", "month", "day_of_week"];
      const browserTimezone = (() => {
        try {
          return Intl.DateTimeFormat().resolvedOptions().timeZone || "Local";
        } catch (_error) {
          return "Local";
        }
      })();

      if (browserTimezoneLabel) {
        browserTimezoneLabel.textContent = browserTimezone;
      }
      const browserOffsetMinutes = -new Date().getTimezoneOffset();

      function setFlash(message, state = "info") {
        if (!message) {
          flash.classList.add("hidden");
          return;
        }
        flash.textContent = message;
        flash.dataset.state = state;
        flash.classList.remove("hidden");
        if (flashTimeoutId) {
          clearTimeout(flashTimeoutId);
        }
        flashTimeoutId = setTimeout(() => {
          flash.classList.add("hidden");
        }, 5000);
      }

      function redirectToLogin() {
        const nextTarget = encodeURIComponent(`${window.location.pathname}${window.location.search}`);
        window.location.href = `/login?next=${nextTarget}`;
      }

      function ensureAuthorized(response) {
        if (!response) {
          return true;
        }

        const contentType = response.headers.get("content-type") || "";
        const unauthorizedHtml = response.status === 200 && contentType.includes("text/html");
        if (response.status === 401 || response.status === 403 || response.redirected || unauthorizedHtml) {
          redirectToLogin();
          return false;
        }
        return true;
      }

      async function readJsonResponse(response) {
        if (!ensureAuthorized(response)) {
          return null;
        }
        const contentType = (response.headers.get("content-type") || "").toLowerCase();
        if (!contentType.includes("application/json")) {
          const text = await response.text();
          const message = text ? text.slice(0, 200) : "Server returned a non-JSON response.";
          throw new Error(message || "Server returned a non-JSON response.");
        }
        try {
          return await response.json();
        } catch (error) {
          throw new Error("Unable to parse server response.");
        }
      }

      const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

      function formatIsoToDisplay(value) {
        if (!value) {
          return "";
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return value;
        }
        const day = String(date.getDate()).padStart(2, "0");
        const month = MONTH_NAMES[date.getMonth()] || "";
        const year = date.getFullYear();
        let hours = date.getHours();
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const suffix = hours >= 12 ? "pm" : "am";
        hours = hours % 12;
        if (hours === 0) {
          hours = 12;
        }
        const hourText = String(hours).padStart(2, "0");
        return `${day} ${month}, ${year} ${hourText}:${minutes}${suffix}`;
      }

      function formatTimestamp(value) {
        if (!value) {
          return "—";
        }
        const display = formatIsoToDisplay(value);
        return display || value;
      }

      function formatDetails(message, details) {
        const lines = [];
        if (message) {
          lines.push(message);
        }

        const info = details && typeof details === "object" ? details : {};

        if (info.function_response) {
          lines.push(`Response:\n${info.function_response}`);
        }

        if (info.log_result) {
          lines.push(`Logs:\n${info.log_result.trim()}`);
        }

        if (info.stdout && !info.metadata) {
          lines.push(`AWS CLI stdout:\n${info.stdout}`);
        }

        if (info.stderr) {
          lines.push(`AWS CLI stderr:\n${info.stderr}`);
        }

        if (Number.isFinite(info.returncode)) {
          lines.push(`Return code: ${info.returncode}`);
        }

        if (info.metadata) {
          lines.push(`Metadata:\n${JSON.stringify(info.metadata, null, 2)}`);
        }

        if (info.error) {
          lines.push(`Error:\n${info.error}`);
        }

        if (!lines.length) {
          return "No runs yet.";
        }

        return lines.join("\n\n");
      }

      function computeLocalEquivalent(timeValue) {
        if (!timeValue || typeof timeValue !== "string") {
          return "";
        }
        const parts = timeValue.split(":");
        if (parts.length < 2) {
          return "";
        }
        const hours = Number.parseInt(parts[0], 10);
        const minutes = Number.parseInt(parts[1], 10);
        if (!Number.isFinite(hours) || !Number.isFinite(minutes)) {
          return "";
        }
        const totalMinutes = hours * 60 + minutes;
        const utcMinutes = totalMinutes - serverOffsetMinutes;
        let localMinutes = utcMinutes + browserOffsetMinutes;
        localMinutes = ((localMinutes % 1440) + 1440) % 1440;
        const localHours = Math.floor(localMinutes / 60);
        const localMins = localMinutes % 60;
        return `${String(localHours).padStart(2, "0")}:${String(localMins).padStart(2, "0")}`;
      }

      function updateDailyLocalEquivalent(value) {
        if (!dailyLocalEquivalentLabel) {
          return;
        }
        const equivalence = computeLocalEquivalent(value);
        dailyLocalEquivalentLabel.textContent = equivalence || "—";
      }

      function setButtonVisibility(button, shouldShow) {
        if (!button) {
          return;
        }
        button.classList.toggle("hidden", !shouldShow);
      }

      function setButtonLoading(button, isLoading, label, loadingLabel, unlockOnFinish = true) {
        if (isLoading) {
          button.disabled = true;
          button.dataset.originalLabel = label || button.textContent;
          button.textContent = loadingLabel || "Working…";
        } else {
          const original = button.dataset.originalLabel || label || button.textContent;
          delete button.dataset.originalLabel;
          if (unlockOnFinish) {
            button.disabled = false;
          }
          button.textContent = original;
        }
      }

      function renderStatus(data) {
        if (!data || typeof data !== "object") {
          return;
        }

        const serverClockDisplay =
          data.server_time_display || (data.server_time ? formatIsoToDisplay(data.server_time) : "");
        serverTimeLabel.textContent = serverClockDisplay || "—";
        serverOffsetMinutes = Number.isFinite(data.server_utc_offset_minutes) ? data.server_utc_offset_minutes : 0;

        const tzName = data.server_timezone || "Unknown";
        if (serverTimezoneLabel) {
          serverTimezoneLabel.textContent = tzName;
        }
        if (serverTimezoneStatus) {
          serverTimezoneStatus.textContent = tzName;
        }

        const cronData = data.cron || {};
        const dailyData = data.daily || {};

        const cronEnabled = Boolean(cronData.enabled);
        cronBadge.textContent = cronEnabled ? "Active" : "Stopped";
        cronBadge.dataset.state = cronEnabled ? "active" : "inactive";
        const cronNextDisplay = cronData.next_run_display || formatIsoToDisplay(cronData.next_run);
        cronNextRunLabel.textContent = cronNextDisplay ? `Next: ${cronNextDisplay}` : "";
        setButtonVisibility(saveScheduleBtn, !cronEnabled);
        setButtonVisibility(stopCronBtn, cronEnabled);

        const dailyEnabled = Boolean(dailyData.enabled);
        dailyBadge.textContent = dailyEnabled ? "Active" : "Stopped";
        dailyBadge.dataset.state = dailyEnabled ? "active" : "inactive";
        const dailyNextDisplay = dailyData.next_run_display || formatIsoToDisplay(dailyData.next_run);
        dailyNextRunLabel.textContent = dailyNextDisplay ? `Next: ${dailyNextDisplay}` : "";
        setButtonVisibility(saveDailyBtn, !dailyEnabled);
        setButtonVisibility(stopDailyBtn, dailyEnabled);

        const schedulerActive = cronEnabled || dailyEnabled || Boolean(data.is_running);
        schedulerBadge.textContent = schedulerActive ? "Active" : "Stopped";
        schedulerBadge.dataset.state = schedulerActive ? "active" : "inactive";

        runningBadge.textContent = data.is_running ? "Running" : "Idle";
        runningBadge.dataset.state = data.is_running ? "active" : "idle";

        triggerLabel.textContent = data.current_trigger ? `(via ${data.current_trigger})` : "";

        const nextCandidates = [];
        if (cronData.next_run) {
          nextCandidates.push({ iso: cronData.next_run, display: cronNextDisplay });
        }
        if (dailyData.next_run) {
          nextCandidates.push({ iso: dailyData.next_run, display: dailyNextDisplay });
        }
        const validNextCandidates = nextCandidates
          .map((entry) => ({ ...entry, date: new Date(entry.iso) }))
          .filter((entry) => !Number.isNaN(entry.date.getTime()));
        validNextCandidates.sort((a, b) => a.date - b.date);
        nextRunLabel.textContent = validNextCandidates.length
          ? validNextCandidates[0].display || formatTimestamp(validNextCandidates[0].iso)
          : "—";

        const lastRunDisplay =
          data.last_run_display || (data.last_run_at ? formatIsoToDisplay(data.last_run_at) : "");
        lastRunLabel.textContent = lastRunDisplay || "Never";
        lastResultText.textContent = data.last_message || "";
        runCountLabel.textContent = data.run_count ?? 0;

        if (data.last_success === true) {
          lastResultBadge.textContent = "Success";
          lastResultBadge.dataset.state = "success";
          output.dataset.status = "success";
        } else if (data.last_success === false) {
          lastResultBadge.textContent = "Failed";
          lastResultBadge.dataset.state = "failed";
          output.dataset.status = "failed";
        } else {
          lastResultBadge.textContent = "Pending";
          lastResultBadge.dataset.state = "idle";
          output.dataset.status = "idle";
        }

        output.textContent = formatDetails(data.last_message, data.last_details);

        if (!scheduleInitialized && cronData.schedule) {
          cronFields.forEach((field) => {
            if (field in cronData.schedule) {
              const input = scheduleForm.elements.namedItem(field);
              if (input) {
                input.value = cronData.schedule[field];
              }
            }
          });
          scheduleInitialized = true;
        }

        if (!dailyInitialized && dailyData.time && dailyInput) {
          dailyInput.value = dailyData.time;
          dailyInitialized = true;
        }
        updateDailyLocalEquivalent(dailyInput ? dailyInput.value : "");

        const jobRunning = Boolean(data.is_running);
        runBtn.textContent = jobRunning ? "Job Running…" : "Run Job Now";
        runBtn.disabled = jobRunning;
      }

      async function refreshStatus() {
        try {
          const response = await fetch("/job/status");
          const data = await readJsonResponse(response);
          if (data === null) {
            return;
          }
          if (!response.ok) {
            throw new Error(`Status check failed (${response.status})`);
          }
          renderStatus(data);
        } catch (error) {
          setFlash(error.message, "error");
        }
      }

      function collectScheduleValues() {
        return cronFields.reduce((acc, field) => {
          const input = scheduleForm.elements.namedItem(field);
          const value = input && input.value ? input.value.trim() : "";
          acc[field] = value || "*";
          return acc;
        }, {});
      }

      scheduleForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setButtonLoading(saveScheduleBtn, true, "Save & Start Cron", "Saving…");
        setFlash("");
        try {
          const payload = collectScheduleValues();
          const response = await fetch("/job/schedule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await readJsonResponse(response);
          if (data === null) {
            return;
          }
          if (!response.ok || data.success === false) {
            throw new Error(data.error || "Unable to update schedule.");
          }
          renderStatus(data);
          setFlash("Cron schedule saved and started.", "success");
        } catch (error) {
          setFlash(error.message, "error");
        } finally {
          setButtonLoading(saveScheduleBtn, false, "Save & Start Cron");
        }
      });

      stopCronBtn.addEventListener("click", async () => {
        setButtonLoading(stopCronBtn, true, "Stop Cron", "Stopping…");
        setFlash("");
        try {
          const response = await fetch("/job/stop", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type: "cron" }),
          });
          const data = await readJsonResponse(response);
          if (data === null) {
            return;
          }
          if (!response.ok || data.success === false) {
            throw new Error(data.error || "Unable to stop cron schedule.");
          }
          renderStatus(data);
          setFlash("Cron schedule stopped.", "info");
        } catch (error) {
          setFlash(error.message, "error");
        } finally {
          setButtonLoading(stopCronBtn, false, "Stop Cron");
        }
      });

      if (dailyForm && dailyInput && saveDailyBtn && stopDailyBtn) {
        dailyInput.addEventListener("input", () => {
          updateDailyLocalEquivalent(dailyInput.value);
        });

        dailyForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const value = dailyInput.value;
          if (!value) {
            setFlash("Please provide a daily time value.", "error");
            return;
          }
          setButtonLoading(saveDailyBtn, true, "Save & Start Daily", "Saving…");
        setFlash("");
        try {
          const response = await fetch("/job/daily", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ time: value }),
          });
          const data = await readJsonResponse(response);
          if (data === null) {
            return;
          }
          if (!response.ok || data.success === false) {
            throw new Error(data.error || "Unable to save daily schedule.");
          }
          dailyInitialized = true;
          renderStatus(data);
            setFlash("Daily schedule saved and started.", "success");
          } catch (error) {
            setFlash(error.message, "error");
          } finally {
            setButtonLoading(saveDailyBtn, false, "Save & Start Daily");
          }
        });

        stopDailyBtn.addEventListener("click", async () => {
          setButtonLoading(stopDailyBtn, true, "Stop Daily", "Stopping…");
        setFlash("");
        try {
          const response = await fetch("/job/stop", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type: "daily" }),
          });
          const data = await readJsonResponse(response);
          if (data === null) {
            return;
          }
          if (!response.ok || data.success === false) {
            throw new Error(data.error || "Unable to stop daily schedule.");
          }
          renderStatus(data);
          setFlash("Daily schedule stopped.", "info");
          } catch (error) {
            setFlash(error.message, "error");
          } finally {
            setButtonLoading(stopDailyBtn, false, "Stop Daily");
          }
        });
      } else {
        console.warn("Daily scheduling controls are missing from the page.");
      }

      runBtn.addEventListener("click", async () => {
        setButtonLoading(runBtn, true, "Run Job Now", "Running…", false);
        output.dataset.status = "running";
        output.textContent = "Job started…";
        setFlash("");
        try {
          const response = await fetch("/job/run", { method: "POST" });
          const data = await readJsonResponse(response);
          if (data === null) {
            return;
          }
          output.textContent = formatDetails(data.message, data.details);
          if (data.success) {
            output.dataset.status = "success";
            setFlash(data.message || "Job completed successfully.", "success");
          } else {
            output.dataset.status = "failed";
            const errorMessage = data.message || data.error || "Job failed.";
            setFlash(errorMessage, "error");
          }
        } catch (error) {
          output.dataset.status = "failed";
          output.textContent = `Unexpected error: ${error}`;
          setFlash("Job failed due to an unexpected error.", "error");
        } finally {
          setButtonLoading(runBtn, false, "Run Job Now", undefined, false);
          await refreshStatus();
        }
      });

      refreshStatus();
      setInterval(refreshStatus, 5000);
    </script>
  </body>
</html>
